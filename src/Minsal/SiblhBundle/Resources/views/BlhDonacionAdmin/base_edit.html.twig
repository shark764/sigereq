{#

This file is part of the Sonata package.

(c) Thomas Rabaix <thomas.rabaix@sonata-project.org>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{#{% extends base_template %}#}
{% extends 'MinsalSiblhBundle:CRUD:base_edit.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    
    {# Bootstrap-calendar #}
    <link href="{{ asset('bundles/minsalsiblh/plugin/bootstrap-datetimepicker-master/build/css/bootstrap-datetimepicker.min.css') }}" type="text/css" rel="stylesheet" />

    {# bootstrap-table #}
    <link href="{{ asset('bundles/minsalsiblh/plugin/bootstrap-table-master/dist/bootstrap-table.min.css') }}" type="text/css" rel="stylesheet" media="screen" />
    
    {# bootstrap-modal #}

    {# bootstrap sweetalert #}
    <link href="{{ asset('bundles/minsalsiblh/plugin/bootstrap-sweetalert-master/dist/sweetalert.css') }}" type="text/css" rel="stylesheet" />
    <link href="{{ asset('bundles/minsalsiblh/css/sweetalert.css') }}" type="text/css" rel="stylesheet" />
{% endblock %}

{% use 'MinsalSiblhBundle:BlhDonacionAdmin:base_edit_form.html.twig' with form as parentForm %}

{% block form %}

    {{ block('parentForm') }}

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {# Bootstrap-calendar #}
    <script type="text/javascript" src="{{ asset('bundles/minsalsiblh/plugin/moment-develop/min/moment-with-locales.min.js') }}" ></script>
    <script type="text/javascript" src="{{ asset('bundles/minsalsiblh/plugin/bootstrap-datetimepicker-master/build/js/bootstrap-datetimepicker.min.js') }}" ></script>

    {# bootstrap-table #}
    <script type="text/javascript" src="{{ asset('bundles/minsalsiblh/plugin/bootstrap-table-master/dist/bootstrap-table.min.js') }}" ></script>
    <script type="text/javascript" src="{{ asset('bundles/minsalsiblh/plugin/bootstrap-table-master/dist/locale/bootstrap-table-es-CR.min.js') }}" ></script>
    
    {# bootstrap-modal #}

    {# bootstrap sweetalert #}
    <script type="text/javascript" src="{{ asset('bundles/minsalsiblh/plugin/bootstrap-sweetalert-master/dist/sweetalert.min.js') }}" ></script>

    <script type="text/javascript">
        //////////////////////////////////////////////////////////////////////////////////////////////
        var donorFormatResult = function(el) {
            var markup = '<div class="row-fluid">' +
                                '<div class="span10">' +
                                '<div class="row-fluid">' +
                                '<div class="span6">' + el.full_name + '</div>' +
                            '</div>';

            markup += '</div></div>';

            return markup;
        };
        //////////////////////////////////////////////////////////////////////////////////////////////

        //////////////////////////////////////////////////////////////////////////////////////////////
        var donorFormatSelection = function(el) {
            return el.full_name;
        };
        //////////////////////////////////////////////////////////////////////////////////////////////

        jQuery(document).ready(function() {
            //////////////////////////////////////////////////////////////////////////////////////////////
            //////// initialize with custom options
            //////////////////////////////////////////////////////////////////////////////////////////////
            var DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_select = jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor');
            DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_select.select2({
                width: 'resolve',
                minimumResultsForSearch: 10,
                dropdownAutoWidth : true,
                allowClear: true,
                placeholder: 'click para seleccionar donante...',
                minimumInputLength: 3,
                maximumSelectionSize: 1,
                // multiple: true,
                escapeMarkup: function(markup) {
                    return markup;
                },
                ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                    url: Routing.generate('siblh_donante_search'),
                    dataType: 'json',
                    quietMillis: 250,
                    data: function (term, page) {
                        var l = DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.val();
                        var t = jQuery('input[name="DONATION_SEARCHDONOR_{{ admin.uniqId }}[search_donor_type_location]"]:checked').val();
                        // var $val = $type.val();
                        return {
                            q: term, // search term
                            t: t, // locale type
                            l: l, // location
                        };
                    },
                    results: function (data, page) { // parse the results into the format expected by Select2.
                        // since we are using custom formatting functions we do not need to alter the remote JSON data
                        return { results: data.items };
                    },
                    cache: true
                },
                initSelection: function(element, callback) {
                    // the input tag has a value attribute preloaded that points to a preselected repository's id
                    // this function resolves that id attribute to an object that select2 can render
                    // using its formatResult renderer - that way the repository name is shown preselected
                    var id = $(element).val();
                    if (id !== "") {
                        var l = DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.val();
                        var t = jQuery('input[name="DONATION_SEARCHDONOR_{{ admin.uniqId }}[search_donor_type_location]"]:checked').val();
                        $.ajax(Routing.generate('siblh_donante_search', {id: id, t: t, l: l}), {
                            dataType: "json"
                        }).done(function(data) { callback(data.item); });
                    }
                },
                formatResult: donorFormatResult,  // display patient information
                formatSelection: donorFormatSelection,    // selection
            });
            //////////////////////////////////////////////////////////////////////////////////////////////

            //////////////////////////////////////////////////////////////////////////////////////////////
            //////// patient record change event
            //////////////////////////////////////////////////////////////////////////////////////////////
            DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_select.on('change', function (e) {
                var rvalue = this.value;

                if (!rvalue) {
                    jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_short_info_container').html('');
                    jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_info_container').html('');
                    jQuery('#{{ admin.uniqId }}_idDonante').val('');
                    return;
                }

                jQuery('#{{ admin.uniqId }}_idDonante').val(rvalue);

                var l = DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.val();
                var t = jQuery('input[name="DONATION_SEARCHDONOR_{{ admin.uniqId }}[search_donor_type_location]"]:checked').val();

                $.getJSON(Routing.generate('siblh_donante_search'), {
                        id : rvalue,
                        t: t,   // locale type
                        l: l, // location
                    })
                    .done(function(data) {
{#
                        // jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_short_info_container').html(displayPreviewSelection(data));
#}
                    })
                    .fail(function(jqxhr, textStatus, error) {
                        //////// patient jumbotron
                        jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_short_info_container').html('');
                        jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_info_container').html('');
                        window.console.log(error, textStatus);
                    });
            });
            //////////////////////////////////////////////////////////////////////////////////////////////

            //////////////////////////////////////////////////////////////////////////////////////////////
            //////// initialize with custom options - LOCATION
            //////////////////////////////////////////////////////////////////////////////////////////////
            var DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select = jQuery('#DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location');
            DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.select2({
                width: 'resolve',
                minimumResultsForSearch: 10,
                dropdownAutoWidth : true,
                allowClear: true,
                placeholder: 'click para seleccionar establecimiento...',
                minimumInputLength: 3,
                maximumSelectionSize: 1,
                // multiple: true,
                escapeMarkup: function(markup) {
                    return markup;
                },
                ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                    url: Routing.generate('siblh_donante_searchLocation'),
                    dataType: 'json',
                    quietMillis: 250,
                    data: function (term, page) {
                        var t = jQuery('input[name="DONATION_SEARCHDONOR_{{ admin.uniqId }}[search_donor_type_location]"]:checked').val();
                        return {
                            q: term, // search term
                            t: t, // locale type
                        };
                    },
                    results: function (data, page) { // parse the results into the format expected by Select2.
                        // since we are using custom formatting functions we do not need to alter the remote JSON data
                        return { results: data.items };
                    },
                    cache: true
                },
                {% if app.user.getIdBancoDeLeche() is not null %}
                    initSelection: function(element, callback) {
                        // // the input tag has a value attribute preloaded that points to a preselected repository's id
                        // // this function resolves that id attribute to an object that select2 can render
                        // // using its formatResult renderer - that way the repository name is shown preselected
                        callback({'id': {{ app.user.getIdBancoDeLeche().getId()|e('js') }}, 'full_name': '{{ app.user.getIdBancoDeLeche().getNombre() }}'});
                    },
                {% elseif app.user.getIdCentroRecoleccion() is not null %}
                    initSelection: function(element, callback) {
                        // // the input tag has a value attribute preloaded that points to a preselected repository's id
                        // // this function resolves that id attribute to an object that select2 can render
                        // // using its formatResult renderer - that way the repository name is shown preselected
                        callback({'id': {{ app.user.getIdCentroRecoleccion().getId()|e('js') }}, 'full_name': '{{ app.user.getIdCentroRecoleccion().getNombre() }}'});
                    },
                {% endif %}
                formatResult: donorFormatResult,  // display patient information
                formatSelection: donorFormatSelection,    // selection
            });
            //////////////////////////////////////////////////////////////////////////////////////////////

            //////////////////////////////////////////////////////////////////////////////////////////////
            //////// patient record change event
            //////////////////////////////////////////////////////////////////////////////////////////////
            DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.on('change', function (e) {
                DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_select.select2('val', '').triggerHandler('change');
            });
            //////////////////////////////////////////////////////////////////////////////////////////////

            //////////////////////////////////////////////////////////////////////////////////////////////
            jQuery('input[name="DONATION_SEARCHDONOR_{{ admin.uniqId }}[search_donor_type_location]"]').on('ifChecked', function(e) {
                DONATION_SEARCHDONOR_{{ admin.uniqId }}_search_donor_location_select.select2('val', '').triggerHandler('change');
            });
            //////////////////////////////////////////////////////////////////////////////////////////////



            //////////////////////////////////////////////////////////////////////////////////////////////
            //////// calculate value
            //////////////////////////////////////////////////////////////////////////////////////////////
            jQuery(document).on('keyup change blur', '[id^="{{ admin.uniqId }}_donacionFrascoRecolectado_"][id$="_volumenRecolectado"]', function(e) {
                var v = this.value;
                if (isNaN(v) || jQuery.trim(v).length === 0) {
                    v = 0;
                }
                var vOz = v * 0.033814;
                jQuery(this).parents('tr').find('[id^="{{ admin.uniqId }}_donacionFrascoRecolectado_"][id$="_onzRecolectado"]').val(vOz.toFixed(4));
                jQuery(this).parents('tr').find('[id^="{{ admin.uniqId }}_donacionFrascoRecolectado_"][id$="_volumenReal"]').val(v);
            });
            //////////////////////////////////////////////////////////////////////////////////////////////
            jQuery(document).on('keyup change blur', '[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_volumenAgregado"]', function(e) {
                var v = this.value;
                if (isNaN(v) || jQuery.trim(v).length === 0) {
                    v = 0;
                }
                var vOz = v * 0.033814;
                jQuery(this).parents('tr').find('[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_onzRecolectado"]').val(vOz.toFixed(4));
                jQuery(this).parents('tr').find('[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_volumenRealAgregado"]').val(v);
            });
            jQuery(document).on('sonata.add_element', '#field_container_{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla', function(e) {
                var subject = jQuery(this);
                jQuery('[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_onzRecolectado"]', subject).each(function() {
                    var ozR = jQuery(this);

                    var v = jQuery(this).parents('tr').find('[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_volumenAgregado"]').val();
                    if (isNaN(v) || jQuery.trim(v).length === 0) {
                        v = 0;
                    }
                    var vOz = v * 0.033814;

                    ozR.val(vOz.toFixed(4));
                });
            });
            //////////////////////////////////////////////////////////////////////////////////////////////
        });

        //////////////////////////////////////////////////////////////////////////////////////////////
        //////// initialize with custom options
        //////////////////////////////////////////////////////////////////////////////////////////////
        jQuery(document).on('sonata.add_element', '#field_container_{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla', function(e) {
            var subject = jQuery(this);
            window.console.log('add mixed bottle', subject.attr('id'), subject.attr('name'));
            jQuery('[id^="{{ admin.uniqId }}_donacionFrascoRecolectadoMezcla_"][id$="_idFrascoRecolectado"]', subject).each(function() {
                var select = jQuery(this);
                select.select2({
                    width: 'resolve',
                    minimumResultsForSearch: 10,
                    dropdownAutoWidth : true,
                    allowClear: true,
                    placeholder: 'click para seleccionar...',
                    minimumInputLength: 3,
                    maximumSelectionSize: 1,
                    // multiple: true,
                    escapeMarkup: function(markup) {
                        return markup;
                    },
                    ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                        url: Routing.generate('siblh_frasco_recolectado_search'),
                        dataType: 'json',
                        quietMillis: 250,
                        data: function (term, page) {
                            return {
                                q: term, // search term
                            };
                        },
                        results: function (data, page) { // parse the results into the format expected by Select2.
                            // since we are using custom formatting functions we do not need to alter the remote JSON data
                            return { results: data.items };
                        },
                        cache: true
                    },
                    // initSelection: function(element, callback) {
                    //     callback({'id': , 'full_name': ''});
                    // },
                    formatResult: collectedBottleFormatResult,  // display patient information
                    formatSelection: collectedBottleFormatSelection,    // selection
                });
                window.console.log('add mixed bottle select', select.attr('id'), select.attr('name'));

                // select.on('change', function (e) {
                // });
            });
        });
        {# #}
        //////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////
        var collectedBottleFormatResult = function(el) {
            var markup = '<div class="row-fluid">' +
                                '<div class="span10">' +
                                '<div class="row-fluid">' +
                                '<div class="span6">' + el.full_name + '</div>' +
                            '</div>';

            markup += '</div></div>';

            return markup;
        };
        //////////////////////////////////////////////////////////////////////////////////////////////

        //////////////////////////////////////////////////////////////////////////////////////////////
        var collectedBottleFormatSelection = function(el) {
            return el.full_name;
        };
        //////////////////////////////////////////////////////////////////////////////////////////////

    </script>
{% endblock %}